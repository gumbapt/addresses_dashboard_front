# API Endpoints Documentation

This document lists all API endpoints used in the application with their request/response formats.

## Authentication

### Login
```
POST /api/admin/login
Content-Type: application/json

Request:
{
  "email": "admin@example.com",
  "password": "password"
}

Response:
{
  "admin": {
    "id": 1,
    "name": "Admin Name",
    "email": "admin@example.com",
    "is_active": true,
    "is_super_admin": false,
    "last_login_at": "2025-10-05 21:59:57"
  },
  "token": "12|...",
  "roles": [
    {
      "id": 1,
      "name": "Administrator",
      "slug": "admin",
      "description": "System Administrator",
      "is_active": true,
      "permissions": [...]
    }
  ]
}
```

### Logout
```
POST /api/admin/logout
Authorization: Bearer {token}
```

### Get Current User
```
GET /api/admin/me
Authorization: Bearer {token}
```

## Users Management

### List Users
```
GET /api/admin/users?page=1&per_page=15
Authorization: Bearer {token}

Response:
{
  "users": [...],
  "pagination": {
    "current_page": 1,
    "per_page": 15,
    "total": 100,
    "last_page": 7,
    "from": 1,
    "to": 15
  }
}
```

## Administrators Management

### List Administrators
```
GET /api/admin/admins?page=1&per_page=15
Authorization: Bearer {token}

Response:
{
  "admins": [...],
  "pagination": {...}
}
```

## Roles Management

### List All Roles
```
GET /api/admin/roles
Authorization: Bearer {token}

Response:
[
  {
    "id": 1,
    "name": "Super Admin",
    "slug": "super-admin",
    "description": "System Super Administrator",
    "is_active": true,
    "permissions": [...],
    "created_at": "2025-10-05 13:40:02",
    "updated_at": "2025-10-05 13:40:02"
  }
]
```

### Create Role
```
POST /api/admin/role/create
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "name": "Manager",
  "description": "Team Manager",
  "permissions": [1, 2, 3] // Optional: Permission IDs
}

Response:
{
  "success": true,
  "data": {
    "role": {
      "id": 4,
      "name": "Manager",
      "slug": "manager", // Auto-generated by backend
      "description": "Team Manager",
      "is_active": true,
      "permissions": [...],
      "created_at": "2025-10-09 10:00:00",
      "updated_at": "2025-10-09 10:00:00"
    }
  }
}
```

### Update Role
```
PUT /api/admin/role/update
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "id": 4,
  "name": "Updated Manager",
  "description": "Updated Description"
}

Response:
{
  "success": true,
  "data": {
    "role": {...}
  }
}
```

### Delete Role
```
POST /api/admin/role/delete
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "id": 4
}

Response:
{
  "success": true
}
```

### Update Role Permissions
```
POST /api/admin/role/update-permissions
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "id": 4,
  "permissions": [1, 2, 3, 4, 5] // Array of permission IDs
}

Response:
{
  "success": true,
  "data": {
    "role": {
      "id": 4,
      "name": "Manager",
      "permissions": [...]
    }
  }
}

Note: Empty array [] removes all permissions
```

## Permissions Management

### List All Permissions
```
GET /api/admin/permissions
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "Create Administrator",
      "slug": "admin-create",
      "description": "Allows creating new administrators",
      "is_active": true,
      "resource": "admin",
      "action": "create",
      "route": null
    }
  ]
}
```

## Error Responses

### Authentication Error
```
{
  "error": "Invalid credentials"
}
Status: 401
```

### Permission Denied
```
{
  "error": "Admin {id} does not have permission to perform this action. Required permission: {permission-slug}"
}
Status: 403
```

### Validation Error
```
{
  "error": "Validation failed",
  "errors": {
    "name": ["The name field is required"],
    "email": ["The email must be a valid email address"]
  }
}
Status: 422
```

### Not Found
```
{
  "error": "Resource not found"
}
Status: 404
```

### Server Error
```
{
  "error": "Internal server error"
}
Status: 500
```

## Domains Management

### List Domains
```
GET /api/admin/domains?page=1&per_page=15&search={query}&is_active={boolean}
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "SmarterHome ISP",
      "slug": "smarterhome-isp",
      "domain_url": "api.smarterhome.com",
      "site_id": "wp-prod-sh-001",
      "api_key": "dmn_live_xxxxxxxxxxx",
      "status": "active",
      "timezone": "America/New_York",
      "is_active": true,
      "wordpress_version": "6.8.3",
      "plugin_version": "2.0.0",
      "settings": {},
      "created_at": "2025-10-11 10:00:00",
      "updated_at": "2025-10-11 10:00:00"
    }
  ],
  "pagination": {
    "total": 50,
    "per_page": 15,
    "current_page": 1,
    "last_page": 4,
    "from": 1,
    "to": 15
  }
}
```

### Get Single Domain
```
GET /api/admin/domains/{id}
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "name": "SmarterHome ISP",
    ...
  }
}
```

### Create Domain
```
POST /api/admin/domains
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "name": "New ISP Platform",
  "domain_url": "api.newisp.com",
  "site_id": "wp-prod-newisp-001", // Optional
  "timezone": "America/New_York", // Optional, default: UTC
  "wordpress_version": "6.8.3", // Optional
  "plugin_version": "2.0.0", // Optional
  "settings": {} // Optional
}

Response:
{
  "success": true,
  "message": "Domain created successfully",
  "data": {
    "id": 5,
    "name": "New ISP Platform",
    "slug": "new-isp-platform", // Auto-generated
    "api_key": "dmn_live_xxxxxxxxxxx", // Auto-generated
    "is_active": true,
    ...
  }
}
```

### Update Domain
```
PUT /api/admin/domains/{id}
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "name": "Updated Name", // Optional
  "domain_url": "api.updated.com", // Optional
  "site_id": "wp-prod-updated-001", // Optional
  "timezone": "UTC", // Optional
  "wordpress_version": "6.8.4", // Optional
  "plugin_version": "2.1.0", // Optional
  "is_active": false, // Optional
  "settings": {} // Optional
}

Response:
{
  "success": true,
  "message": "Domain updated successfully",
  "data": {
    "id": 5,
    "name": "Updated Name",
    "slug": "updated-name", // Auto-regenerated
    ...
  }
}
```

### Delete Domain
```
DELETE /api/admin/domains/{id}
Authorization: Bearer {token}

Response:
{
  "success": true,
  "message": "Domain deleted successfully"
}
```

### Regenerate API Key
```
POST /api/admin/domains/{id}/regenerate-api-key
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "id": 5,
    "name": "Domain Name",
    "api_key": "dmn_live_new_key_xxxxxxxx",
    ...
  }
}

Note: The old API key will be immediately invalidated
```

## Reports Management

### List Reports
```
GET /api/admin/reports?page={page}&per_page={perPage}&domain_id={id}&status={status}&start_date={date}&end_date={date}
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "domain_id": 5,
      "report_date": "2025-10-15",
      "status": "processed",
      "data_version": "1.0",
      "created_at": "2025-10-15 10:00:00",
      "updated_at": "2025-10-15 10:05:00"
    }
  ],
  "meta": {
    "total": 100,
    "per_page": 15,
    "current_page": 1,
    "last_page": 7,
    "from": 1,
    "to": 15
  }
}

Query Parameters:
- page: Page number (default: 1)
- per_page: Items per page (min: 1, max: 100, default: 15)
- domain_id: Filter by specific domain
- status: Filter by status (pending, processing, processed, failed)
- start_date: Filter reports from this date (YYYY-MM-DD)
- end_date: Filter reports until this date (YYYY-MM-DD)
```

### Get Single Report
```
GET /api/admin/reports/{id}
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "domain_id": 5,
    "report_date": "2025-10-15",
    "status": "processed",
    "data_version": "1.0",
    "raw_data": {
      "source": {"domain": "test.com"},
      "metadata": {"report_date": "2025-10-13"},
      "summary": {"total_requests": 100}
    },
    "processed_data": {
      "metrics": {...}
    },
    "error_message": null,
    "created_at": "2025-10-15 10:00:00",
    "updated_at": "2025-10-15 10:05:00",
    "domain": {
      "id": 5,
      "name": "example.com",
      ...
    }
  }
}
```

### Get Recent Reports
```
GET /api/admin/reports/recent
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": [
    // Array of up to 10 most recent reports
    {
      "id": 1,
      "domain_id": 5,
      "report_date": "2025-10-15",
      "status": "processed",
      "data_version": "1.0",
      "created_at": "2025-10-15 10:00:00",
      "updated_at": "2025-10-15 10:05:00"
    }
  ]
}

Note: Returns maximum 10 most recent reports ordered by creation date
```

### Report Not Found
```
GET /api/admin/reports/99999

Response:
{
  "success": false,
  "message": "Report not found"
}
Status: 404
```

## Global Reports

### Global Domain Ranking
```
GET /api/admin/reports/global/domain-ranking?sort_by={sortBy}&date_from={date}&date_to={date}&min_reports={num}
Authorization: Bearer {token}

Query Parameters:
- sort_by: score (default) | volume | success | speed
- date_from: Filter from date (YYYY-MM-DD)
- date_to: Filter to date (YYYY-MM-DD)
- min_reports: Minimum number of reports required

Response:
{
  "success": true,
  "data": {
    "ranking": [
      {
        "rank": 1,
        "domain": {
          "id": 1,
          "name": "smarterhome.ai",
          "slug": "smarterhome-ai"
        },
        "metrics": {
          "total_requests": 3781,
          "success_rate": 96.0,
          "avg_speed": 1150.0,
          "score": 2.56,
          "unique_providers": 25,
          "unique_states": 40
        },
        "coverage": {
          "total_reports": 40,
          "period_start": "2025-07-01",
          "period_end": "2025-10-01",
          "days_covered": 93
        }
      }
    ],
    "sort_by": "score",
    "total_domains": 4
  }
}
```

### Domain Comparison
```
GET /api/admin/reports/global/comparison?domains={id1,id2,...}&metric={metric}&date_from={date}&date_to={date}
Authorization: Bearer {token}

Query Parameters:
- domains: Comma-separated domain IDs (required, min: 2)
- metric: Optional detailed metric (geographic, providers, technologies)
- date_from: Filter from date (YYYY-MM-DD)
- date_to: Filter to date (YYYY-MM-DD)

Response:
{
  "success": true,
  "data": {
    "domains": [
      {
        "domain": {
          "id": 1,
          "name": "zip.50g.io",
          "slug": "zip-50g-io"
        },
        "metrics": {
          "total_requests": 1490,
          "success_rate": 92.38,
          "avg_speed": 1006.47,
          "unique_providers": 8,
          "unique_states": 43
        }
      },
      {
        "domain": {
          "id": 2,
          "name": "smarterhome.ai",
          "slug": "smarterhome-ai"
        },
        "metrics": {
          "total_requests": 3781,
          "success_rate": 95.98,
          "avg_speed": 1149.82,
          "unique_providers": 25,
          "unique_states": 40
        },
        "comparison": {
          "requests_diff": 153.8,
          "requests_diff_label": "+153.8%",
          "success_diff": 3.6,
          "success_diff_label": "+3.6%",
          "speed_diff": 14.2,
          "speed_diff_label": "+14.2%"
        }
      }
    ],
    "base_domain_id": 1
  }
}

Note: First domain in the list is used as baseline. Other domains show percentage differences.
```

## Permission Required by Endpoint

| Endpoint | Permission Required |
|----------|-------------------|
| GET /users | `user-read` |
| GET /admins | `admin-read` |
| GET /roles | `role-read` |
| POST /role/create | `role-create` |
| PUT /role/update | `role-update` |
| POST /role/delete | `role-delete` |
| POST /role/update-permissions | `role-manage` |
| GET /permissions | `role-read` or `role-manage` |
| GET /domains | `domain-read` |
| GET /domains/{id} | `domain-read` |
| POST /domains | `domain-create` |
| PUT /domains/{id} | `domain-update` |
| DELETE /domains/{id} | `domain-delete` |
| POST /domains/{id}/regenerate-api-key | `domain-update` |
| GET /reports | `report-read` |
| GET /reports/{id} | `report-read` |
| GET /reports/recent | `report-read` |
| GET /reports/global/domain-ranking | `report-read` |
| GET /reports/global/comparison | `report-read` |

## Notes

- All endpoints (except login) require `Authorization: Bearer {token}` header
- Super admins bypass all permission checks
- Tokens are returned on login and should be stored in localStorage
- Permissions are loaded from roles automatically on login
